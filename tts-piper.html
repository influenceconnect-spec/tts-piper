<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Texte ‚Üí Parole (WAV local, sans quota)</title>
  <style>
    :root{ color-scheme: light dark; }
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial; background:#222222; color:#f2f2f2}
    .page{min-height:100svh; display:grid; place-items:center; padding:clamp(12px, 2.5vw, 32px)}
    .demo{max-width:900px; width:100%}
    .card{background:#2b2b2b; border:1px solid #3b3b3b; border-radius:16px; padding:clamp(12px, 2.2vw, 18px);}
    .row{display:grid; gap:10px}
    @media(min-width:900px){.row{grid-template-columns:minmax(0,1fr) minmax(280px,380px)}}
    label{font-size:.9rem; color:#bfbfbf}
    textarea{resize:none; min-height:160px; width:100%; border-radius:12px; padding:14px; outline:none; border:1px solid #3b3b3b; background:#1f1f1f; color:#f2f2f2}
    textarea:focus{box-shadow: 0 0 0 3px rgba(0,255,163,.25)}
    select, input[type="range"], button{font:inherit}
    select{width:100%; border:1px solid #3b3b3b; border-radius:12px; padding:10px; background:#1f1f1f; color:#f2f2f2}
    .controls{display:flex; flex-wrap:wrap; gap:10px}
    .btn{border:1px solid #00FFA3; background:#00FFA3; color:#000; font-weight:700; padding:10px 14px; border-radius:999px; cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    input[type="range"]{width:100%; accent-color:#00FFA3}
    input[type="range"]::-webkit-slider-runnable-track{height:6px; border-radius:999px; background: rgba(0,255,163,.3)}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%; background:#00FFA3; border:2px solid #000; margin-top:-6px}
    input[type="range"]::-moz-range-track{height:6px; border-radius:999px; background: rgba(0,255,163,.3)}
    input[type="range"]::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#00FFA3; border:2px solid #000}
    .meta{display:flex; justify-content:space-between; color:#bfbfbf; font-size:.85rem}
    .status{color:#bfbfbf; font-size:.9rem; margin-bottom:6px}
    .ok{color:#00FFA3}
    .err{color:#ff6b6b}
    audio{width:100%; margin-top:8px}
    details{margin-top:10px; color:#bbb}
    summary{cursor:pointer}
    code{background:#0003; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="page">
    <div class="demo">
      <div class="card">
        <div class="status" id="status">Initialisation‚Ä¶</div>
        <div class="row">
          <div>
            <label for="text">Texte</label>
            <textarea id="text" placeholder="√âcris ou colle un texte ici‚Ä¶">Bonjour et bienvenue sur notre synth√®se vocale en ligne.</textarea>
            <div class="meta"><span id="count">0 caract√®re</span><span id="src">Source¬†: meSpeak (WAV local)</span></div>
            <div class="controls" style="margin-top:8px">
              <button class="btn" id="preview" disabled>‚ñ∂Ô∏è √âcouter</button>
              <button class="btn" id="download" disabled>üíæ T√©l√©charger WAV</button>
            </div>
            <audio id="player" controls hidden></audio>
          </div>
          <div>
            <label for="voice">Voix</label>
            <select id="voice"></select>
            <div style="height:8px"></div>
            <label for="rate">Vitesse (sortie): <span id="rateVal">1.00√ó</span></label>
            <input id="rate" type="range" min="0.7" max="1.4" value="1" step="0.05" />
            <div style="height:8px"></div>
            <div style="font-size:.85rem;color:#bbb">Astuces¬†: choisis une variante (grave/neutre/femme/robot), √©coute, puis t√©l√©charge en WAV. Tout est g√©n√©r√© dans ton navigateur.</div>
          </div>
        </div>
      </div>

      <details>
        <summary>üß™ Diagnostic & tests</summary>
        <div style="font-size:.9rem; line-height:1.6; margin-top:8px">
          <div id="diag"></div>
          <div class="controls"><button id="selftest" class="btn">‚ñ∂Ô∏è Lancer l‚Äôauto‚Äëtest</button></div>
        </div>
      </details>
    </div>
  </div>

  <script>
    (function(){
      const $ = sel => document.querySelector(sel);
      const status = (msg, cls='')=>{ const el=$('#status'); el.textContent=msg; el.className='status '+cls; };
      const diag = (line)=>{ const d=$('#diag'); if(d) d.insertAdjacentHTML('beforeend', `<div>${line}</div>`); };

      const vSel=$('#voice'), txt=$('#text'), cnt=$('#count'), rate=$('#rate'), rateVal=$('#rateVal'), player=$('#player');
      const btnPrev=$('#preview'), btnDown=$('#download'), btnTest=$('#selftest');

      const VOICES = [
        {id:'fr:m3', label:'FR ‚Äî Homme (m3)', opt:{voice:'fr', variant:'m3'}},
        {id:'fr:m1', label:'FR ‚Äî Neutre (m1)', opt:{voice:'fr', variant:'m1'}},
        {id:'fr:f5', label:'FR ‚Äî Femme (f5)', opt:{voice:'fr', variant:'f5'}},
        {id:'fr:robot', label:'FR ‚Äî Robot (rapide)', opt:{voice:'fr', variant:'m1', speed:200, pitch:40}}
      ];

      function populateVoices(){ vSel.innerHTML=''; VOICES.forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.label; vSel.appendChild(o); }); }
      function updateCount(){ const n=(txt.value||'').length; cnt.textContent = n+(n>1?' caract√®res':' caract√®re'); }
      function autoresize(){ txt.style.height='auto'; const max=420; txt.style.height=Math.min(txt.scrollHeight+2, max)+'px'; }
      function timestamp(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; }
      function downloadDataUrl(dataUrl, filename){ const a=document.createElement('a'); a.href=dataUrl; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ a.remove(); }, 100); }

      // --- Charge meSpeak de mani√®re fiable (essaye 2 CDNs) ---
      async function loadMeSpeakScript(){
        const urls=[
          'https://cdn.jsdelivr.net/npm/mespeak@2.0.2/mespeak.min.js',
          'https://unpkg.com/mespeak@2.0.2/mespeak.min.js'
        ];
        for(const src of urls){
          try{ await new Promise((res, rej)=>{ const s=document.createElement('script'); s.src=src; s.async=false; s.onload=()=>res(); s.onerror=()=>rej(new Error('load '+src)); document.head.appendChild(s); }); if(window.meSpeak){ diag('‚úÖ meSpeak charg√© depuis: '+src); return true; } }
          catch(e){ diag('‚ö†Ô∏è meSpeak script KO: '+e.message); }
        }
        return false;
      }

      // --- Initialise meSpeak (voix FR) ---
      async function initMeSpeak(){
        if(!window.meSpeak){ const ok = await loadMeSpeakScript(); if(!ok){ status('‚ùå meSpeak non charg√©','err'); return false; } }
        try{
          // v2: pas besoin de loadConfig ; on charge directement la voix FR depuis jsDelivr
          await new Promise((resolve,reject)=> window.meSpeak.loadVoice('https://cdn.jsdelivr.net/npm/mespeak@2.0.2/voices/fr.json', ok=> ok?resolve():reject(new Error('voice'))));
          status('‚úÖ Pr√™t','ok');
          btnPrev.disabled=false; btnDown.disabled=false;
          return true;
        }catch(e){ status('‚ùå √âchec voix FR ('+(e&&e.message||e)+')','err'); diag('init voice error: '+(e&&e.message||e)); return false; }
      }

      // --- G√©n√®re un WAV (data URL) en ASYNC (API v2: callback requis) ---
      function synthDataUrlAsync(text){
        return new Promise((resolve,reject)=>{
          if(!window.meSpeak) return reject(new Error('meSpeak non charg√©'));
          const sel = VOICES.find(v=>v.id===vSel.value) || VOICES[0];
          const speed = Math.round((parseFloat(rate.value)||1)*100); // ~100 = 1√ó
          const opts = Object.assign({ rawdata: 'data-url', amplitude:100, pitch:(sel.opt.pitch||50), speed:(sel.opt.speed||speed) }, sel.opt);
          try{
            window.meSpeak.speak(text, opts, (ok, id, stream)=>{
              if(ok && typeof stream==='string' && stream.startsWith('data:')) return resolve(stream);
              if(!ok) return reject(new Error(id||'g√©n√©ration'));
              return reject(new Error('flux inattendu'));
            });
          }catch(e){ reject(e); }
        });
      }

      // --- Actions ---
      btnPrev.addEventListener('click', async ()=>{
        const t=(txt.value||'').trim()||'Bonjour, ceci est un test.';
        try{
          status('G√©n√©ration pour √©coute‚Ä¶');
          const url = await synthDataUrlAsync(t);
          player.hidden=false; player.src=url; await player.play().catch(()=>{});
          status('Lecture');
        }catch(e){ status('‚ùå Lecture indisponible ('+(e&&e.message||e)+')','err'); diag('preview: '+(e&&e.message||e)); }
      });

      btnDown.addEventListener('click', async ()=>{
        const t=(txt.value||'').trim(); if(!t){ status('Ajoute du texte.'); txt.focus(); return; }
        try{
          status('G√©n√©ration‚Ä¶');
          const url = await synthDataUrlAsync(t);
          downloadDataUrl(url, 'tts-'+timestamp()+'.wav');
          status('WAV t√©l√©charg√© ‚úÖ','ok');
        }catch(e){ status('‚ùå G√©n√©ration impossible ('+(e&&e.message||e)+')','err'); diag('download: '+(e&&e.message||e)); }
      });

      btnTest.addEventListener('click', async ()=>{
        const out=[]; out.push('Navigator.isSecureContext='+(window.isSecureContext?'‚úÖ':'‚ö†Ô∏è'));
        out.push('meSpeak pr√©sent: '+(!!window.meSpeak?'‚úÖ':'‚ùå'));
        try{ const a=await synthDataUrlAsync('Bonjour, ceci est un test.'); const b=await synthDataUrlAsync('Salut, nouveau test.'); out.push('WAV data-url A: '+a.length+' chars'); out.push('WAV data-url B: '+b.length+' chars'); out.push((a!==b)?'‚úÖ G√©n√©ration OK':'‚ö†Ô∏è M√™me taille (v√©rifier audio)'); }
        catch(e){ out.push('‚ùå Auto-test KO: '+(e&&e.message||e)); }
        $('#diag').innerHTML=out.join('<br>');
      });

      // UI init
      populateVoices();
      updateCount(); autoresize(); txt.addEventListener('input', ()=>{ updateCount(); autoresize(); });
      rate.addEventListener('input', ()=>{ const v=parseFloat(rate.value)||1; rateVal.textContent=v.toFixed(2)+'√ó'; });

      // Boot
      (async ()=>{ await initMeSpeak(); })();
    })();
  </script>
</body>
</html>
