<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Texte ‚Üí Parole (WAV local, sans quota)</title>
  <style>
    :root{ color-scheme: light dark; }
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial; background:#222222; color:#f2f2f2}
    .page{min-height:100svh; display:grid; place-items:center; padding:clamp(12px, 2.5vw, 32px)}
    .demo{max-width:900px; width:100%}
    .card{background:#2b2b2b; border:1px solid #3b3b3b; border-radius:16px; padding:clamp(12px, 2.2vw, 18px);}
    .row{display:grid; gap:10px}
    @media(min-width:900px){.row{grid-template-columns:minmax(0,1fr) minmax(280px,380px)}}
    label{font-size:.9rem; color:#bfbfbf}
    textarea{resize:none; min-height:160px; width:100%; border-radius:12px; padding:14px; outline:none; border:1px solid #3b3b3b; background:#1f1f1f; color:#f2f2f2}
    textarea:focus{box-shadow: 0 0 0 3px rgba(0,255,163,.25)}
    select, input[type="range"], button{font:inherit}
    select{width:100%; border:1px solid #3b3b3b; border-radius:12px; padding:10px; background:#1f1f1f; color:#f2f2f2}
    .controls{display:flex; flex-wrap:wrap; gap:10px}
    .btn{border:1px solid #00FFA3; background:#00FFA3; color:#000; font-weight:700; padding:10px 14px; border-radius:999px; cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    input[type="range"]{width:100%; accent-color:#00FFA3}
    input[type="range"]::-webkit-slider-runnable-track{height:6px; border-radius:999px; background: rgba(0,255,163,.3)}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%; background:#00FFA3; border:2px solid #000; margin-top:-6px}
    input[type="range"]::-moz-range-track{height:6px; border-radius:999px; background: rgba(0,255,163,.3)}
    input[type="range"]::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#00FFA3; border:2px solid #000}
    .meta{display:flex; justify-content:space-between; color:#bfbfbf; font-size:.85rem}
    .status{color:#bfbfbf; font-size:.9rem; margin-bottom:6px}
    .ok{color:#00FFA3}
    .err{color:#ff6b6b}
    audio{width:100%; margin-top:8px}
    details{margin-top:10px; color:#bbb}
    summary{cursor:pointer}
    code{background:#0003; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="page">
    <div class="demo">
      <div class="card">
        <div class="status" id="status">Pr√™t</div>
        <div class="row">
          <div>
            <label for="text">Texte</label>
            <textarea id="text" placeholder="√âcris ou colle un texte ici‚Ä¶">Bonjour et bienvenue sur notre synth√®se vocale en ligne.</textarea>
            <div class="meta"><span id="count">0 caract√®re</span><span id="src">Source¬†: meSpeak (WAV local)</span></div>
            <div class="controls" style="margin-top:8px">
              <button class="btn" id="preview">‚ñ∂Ô∏è √âcouter</button>
              <button class="btn" id="download">üíæ T√©l√©charger WAV</button>
            </div>
            <audio id="player" controls hidden></audio>
          </div>
          <div>
            <label for="voice">Voix</label>
            <select id="voice"></select>
            <div style="height:8px"></div>
            <label for="rate">Vitesse (sortie): <span id="rateVal">1.00√ó</span></label>
            <input id="rate" type="range" min="0.7" max="1.4" value="1" step="0.05" />
            <div style="height:8px"></div>
            <div style="font-size:.85rem;color:#bbb">Astuces¬†: choisis une variante (grave/femme/robot), √©coute, puis t√©l√©charge en WAV. Tout est g√©n√©r√© dans ton navigateur.</div>
          </div>
        </div>
      </div>

      <details>
        <summary>üß™ Diagnostic & tests</summary>
        <div style="font-size:.9rem; line-height:1.6; margin-top:8px">
          <div id="diag"></div>
          <div class="controls"><button id="selftest" class="btn">‚ñ∂Ô∏è Lancer l‚Äôauto‚Äëtest</button></div>
        </div>
      </details>
    </div>
  </div>

  <!-- meSpeak (biblioth√®que). Version √©pingl√©e pour stabilit√©. -->
  <script src="https://cdn.jsdelivr.net/npm/mespeak@2.0.2/mespeak.min.js"></script>
  <script>
    (function(){
      const VOICES = [
        {id:'fr:m3', label:'FR ‚Äî Homme (m3)', opt:{voice:'fr', variant:'m3'}},
        {id:'fr:m1', label:'FR ‚Äî Neutre (m1)', opt:{voice:'fr', variant:'m1'}},
        {id:'fr:f5', label:'FR ‚Äî Femme (f5)', opt:{voice:'fr', variant:'f5'}},
        {id:'fr:robot', label:'FR ‚Äî Robot (rapide)', opt:{voice:'fr', variant:'m1', speed:200, pitch:40}}
      ];

      const $ = sel => document.querySelector(sel);
      const status = (msg, cls='')=>{ const el=$('#status'); el.textContent=msg; el.className='status '+cls; };
      const diag = (line)=>{ const d=$('#diag'); if(d) d.insertAdjacentHTML('beforeend', `<div>${line}</div>`); };

      // UI refs
      const vSel=$('#voice'), txt=$('#text'), cnt=$('#count'), rate=$('#rate'), rateVal=$('#rateVal'), player=$('#player');
      const btnPrev=$('#preview'), btnDown=$('#download'), btnTest=$('#selftest');

      // Populate voices
      function populateVoices(){ vSel.innerHTML=''; VOICES.forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.label; vSel.appendChild(o); }); }

      function updateCount(){ const n=(txt.value||'').length; cnt.textContent = n+(n>1?' caract√®res':' caract√®re'); }
      function autoresize(){ txt.style.height='auto'; const max=420; txt.style.height=Math.min(txt.scrollHeight+2, max)+'px'; }

      // Load meSpeak config+voice
      async function initMeSpeak(){
        if(!window.meSpeak){ status('‚ùå Biblioth√®que meSpeak non charg√©e (bloqu√©e par l‚Äôiframe¬†?)','err'); diag('meSpeak undefined'); return false; }
        status('‚è≥ Chargement meSpeak‚Ä¶');
        try{
          await new Promise((resolve,reject)=> meSpeak.loadConfig('https://cdn.jsdelivr.net/npm/mespeak@2.0.2/mespeak_config.json', ok=> ok?resolve():reject(new Error('config'))));
          await new Promise((resolve,reject)=> meSpeak.loadVoice('https://cdn.jsdelivr.net/npm/mespeak@2.0.2/voices/fr.json', ok=> ok?resolve():reject(new Error('voice'))));
          status('‚úÖ Pr√™t','ok');
          return true;
        }catch(e){ status('‚ùå √âchec chargement meSpeak ('+(e&&e.message||e)+')','err'); diag('init error: '+(e&&e.message||e)); return false; }
      }

      // Synthesize to data URL (WAV)
      function synthDataUrl(text){
        if(!window.meSpeak) throw new Error('meSpeak non charg√©');
        const sel = VOICES.find(v=>v.id===vSel.value) || VOICES[0];
        const speed = ((parseFloat(rate.value)||1)*100)|0; // meSpeak speed 80..450 (approx). 100 ~ 1x
        const opts = Object.assign({ rawdata:'data-url', amplitude:100, pitch: (sel.opt.pitch||50), speed: (sel.opt.speed||100) }, sel.opt);
        // meSpeak.speak retourne une data URL synchronement quand rawdata='data-url'
        const dataUrl = meSpeak.speak(text, opts);
        if(!dataUrl || typeof dataUrl!=='string' || !dataUrl.startsWith('data:')) throw new Error('data-url vide');
        return dataUrl;
      }

      function downloadDataUrl(dataUrl, filename){ const a=document.createElement('a'); a.href=dataUrl; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ a.remove(); }, 100); }
      function timestamp(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; }

      // Event handlers
      btnPrev.addEventListener('click', ()=>{
        const t=(txt.value||'').trim()||'Bonjour, ceci est un test.';
        try{
          const url = synthDataUrl(t);
          player.hidden=false; player.src=url; player.play().catch(()=>{});
          status('Lecture');
        }catch(e){ status('‚ùå Lecture indisponible ('+(e&&e.message||e)+')','err'); diag('preview: '+(e&&e.message||e)); }
      });

      btnDown.addEventListener('click', ()=>{
        const t=(txt.value||'').trim(); if(!t){ status('Ajoute du texte.'); txt.focus(); return; }
        try{
          const url = synthDataUrl(t);
          downloadDataUrl(url, 'tts-'+timestamp()+'.wav');
          status('WAV t√©l√©charg√© ‚úÖ','ok');
        }catch(e){ status('‚ùå G√©n√©ration impossible ('+(e&&e.message||e)+')','err'); diag('download: '+(e&&e.message||e)); }
      });

      btnTest.addEventListener('click', ()=>{
        const out=[]; out.push('Navigator.isSecureContext='+(window.isSecureContext?'‚úÖ':'‚ö†Ô∏è'));
        if(!window.meSpeak){ out.push('meSpeak: ‚ùå non charg√©'); $('#diag').innerHTML=out.join('<br>'); return; }
        try{
          const a=synthDataUrl('Bonjour, ceci est un test.');
          const b=synthDataUrl('Salut, nouveau test.');
          out.push('WAV data-url A: '+a.length+' chars');
          out.push('WAV data-url B: '+b.length+' chars');
          out.push((a!==b)?'‚úÖ G√©n√©ration OK':'‚ö†Ô∏è Tailles identiques (v√©rifier audio)');
        }catch(e){ out.push('‚ùå Auto-test KO: '+(e&&e.message||e)); }
        $('#diag').innerHTML=out.join('<br>');
      });

      // Init UI
      populateVoices();
      updateCount(); autoresize(); txt.addEventListener('input', ()=>{ updateCount(); autoresize(); });
      rate.addEventListener('input', ()=>{ const v=parseFloat(rate.value)||1; rateVal.textContent=v.toFixed(2)+'√ó'; });

      // Boot
      initMeSpeak();
    })();
  </script>
</body>
</html>
